name: 自动更新三国杀配置文件

on:
  schedule:
  
    - cron: '0 0 * * *'
  workflow_dispatch: # 允许手动触发


permissions:
  contents: write

jobs:
  update-config:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout 仓库
        uses: actions/checkout@v4
      
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: 从 Worker 下载并保存文件
        run: |
          # Worker 代理地址
          WORKER_URL="https://steep-king-e329.1-873.workers.dev"
          
          # 获取文件列表
          echo "获取文件列表..."
          curl -s "$WORKER_URL/list" > file-list.json
          cat file-list.json
          
          # 解析并下载文件
          node << 'EOF'
          const fs = require('fs');
          const https = require('https');
          const path = require('path');
          
          const WORKER_URL = 'https://steep-king-e329.1-873.workers.dev';
          const fileList = JSON.parse(fs.readFileSync('file-list.json', 'utf8'));
          
          function downloadFile(url) {
            return new Promise((resolve, reject) => {
              https.get(url, (res) => {
                if (res.statusCode !== 200) {
                  reject(new Error(`下载失败: ${res.statusCode}`));
                  return;
                }
                
                const chunks = [];
                res.on('data', chunk => chunks.push(chunk));
                res.on('end', () => resolve(Buffer.concat(chunks).toString('utf8')));
                res.on('error', reject);
              }).on('error', reject);
            });
          }
          
          async function processDirectory(directory, files) {
            console.log(`\n处理目录: ${directory} (${files.length} 个文件)`);
            
            // 创建目录
            if (!fs.existsSync(directory)) {
              fs.mkdirSync(directory, { recursive: true });
            }
            
            let success = 0;
            let failed = 0;
            
            for (const fileName of files) {
              try {
                const url = `${WORKER_URL}/${encodeURIComponent(directory)}/${encodeURIComponent(fileName)}`;
                console.log(`  下载: ${fileName}`);
                
                const content = await downloadFile(url);
                const filePath = path.join(directory, fileName);
                
                fs.writeFileSync(filePath, content, 'utf8');
                success++;
                
                // 延迟避免请求过快
                await new Promise(resolve => setTimeout(resolve, 100));
                
              } catch (error) {
                console.error(`  ✗ ${fileName}: ${error.message}`);
                failed++;
              }
            }
            
            console.log(`${directory}: 成功 ${success}, 失败 ${failed}`);
          }
          
          (async () => {
            for (const [directory, files] of Object.entries(fileList)) {
              await processDirectory(directory, files);
            }
            console.log('\n全部完成！');
          })().catch(err => {
            console.error('错误:', err);
            process.exit(1);
          });
          EOF
      
      - name: 提交更改
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "没有文件变化"
          else
            git commit -m "自动更新配置文件 - $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          fi

