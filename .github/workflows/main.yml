name: 监控三国杀配置文件更新

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  monitor-and-trigger:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      TZ: Asia/Shanghai

    steps:
      - name: 检出公共仓库
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.READONLY_TOKEN }}

      - name: 检查配置文件更新
        id: check
        run: |
          URL_TEN="https://web.sanguosha.com/10/pc/res/config/Config.sgs"
          URL_OL="https://web.sanguosha.com/220/h5_2/res/config/Config_w.sgs"
          
          mkdir -p .etag-cache
          
          echo "=== 检查十周年配置 ==="
          HEADERS_TEN=$(curl -sI "$URL_TEN" 2>&1)
          ETAG_TEN=$(echo "$HEADERS_TEN" | grep -i "^etag:" | cut -d' ' -f2- | tr -d '\r\n "')
          LASTMOD_TEN=$(echo "$HEADERS_TEN" | grep -i "^last-modified:" | cut -d' ' -f2- | tr -d '\r\n')
          echo "当前 ETag: [$ETAG_TEN]"
          echo "当前 Last-Modified: [$LASTMOD_TEN]"
          
          LAST_ETAG_TEN=$(cat .etag-cache/etag_ten.txt 2>/dev/null || echo "")
          LAST_MOD_TEN=$(cat .etag-cache/mod_ten.txt 2>/dev/null || echo "")
          
          CHANGED_TEN=false
          if [ -n "$ETAG_TEN" ] && ([ "$ETAG_TEN" != "$LAST_ETAG_TEN" ] || [ "$LASTMOD_TEN" != "$LAST_MOD_TEN" ]); then
            echo "十周年配置已更新"
            echo "$ETAG_TEN" > .etag-cache/etag_ten.txt
            echo "$LASTMOD_TEN" > .etag-cache/mod_ten.txt
            CHANGED_TEN=true
          else
            echo "十周年配置无变化"
          fi
          
          echo "=== 检查OL配置 ==="
          HEADERS_OL=$(curl -sI "$URL_OL" 2>&1)
          ETAG_OL=$(echo "$HEADERS_OL" | grep -i "^etag:" | cut -d' ' -f2- | tr -d '\r\n "')
          LASTMOD_OL=$(echo "$HEADERS_OL" | grep -i "^last-modified:" | cut -d' ' -f2- | tr -d '\r\n')
          echo "当前 ETag: [$ETAG_OL]"
          echo "当前 Last-Modified: [$LASTMOD_OL]"
          
          LAST_ETAG_OL=$(cat .etag-cache/etag_ol.txt 2>/dev/null || echo "")
          LAST_MOD_OL=$(cat .etag-cache/mod_ol.txt 2>/dev/null || echo "")
          
          CHANGED_OL=false
          if [ -n "$ETAG_OL" ] && ([ "$ETAG_OL" != "$LAST_ETAG_OL" ] || [ "$LASTMOD_OL" != "$LAST_MOD_OL" ]); then
            echo "OL配置已更新"
            echo "$ETAG_OL" > .etag-cache/etag_ol.txt
            echo "$LASTMOD_OL" > .etag-cache/mod_ol.txt
            CHANGED_OL=true
          else
            echo "OL配置无变化"
          fi
          
          if [ "$CHANGED_TEN" = true ] || [ "$CHANGED_OL" = true ]; then
            echo "has_change=true" >> $GITHUB_OUTPUT
          else
            echo "has_change=false" >> $GITHUB_OUTPUT
          fi

      - name: 提交ETag缓存
        if: steps.check.outputs.has_change == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -f .etag-cache/
          git status
          
          if git diff --staged --quiet; then
            echo "没有变化需要提交"
          else
            git commit -m "更新ETag缓存 $(date +'%Y-%m-%d %H:%M:%S')"
            git remote set-url origin https://x-access-token:${{ secrets.READONLY_TOKEN }}@github.com/${{ github.repository }}.git
            git push
            echo "ETag缓存已提交"
          fi

      - name: 触发私有仓库解密
        run: |
          echo "触发私有仓库解密"
          
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.READONLY_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ secrets.PRIVATE_REPO_OWNER }}/${{ secrets.PRIVATE_REPO_NAME }}/dispatches \
            -d '{"event_type":"sgs-config-updated","client_payload":{"timestamp":"'$(date -Iseconds)'","changed":["十周年","ol"],"force":true}}'
          
          echo "触发成功"
          echo "当前 ETag: [$ETAG_TEN]"
          echo "当前 Last-Modified: [$LASTMOD_TEN]"
          
          LAST_ETAG_TEN=$(cat .etag-cache/etag_ten.txt 2>/dev/null || echo "")
          LAST_MOD_TEN=$(cat .etag-cache/mod_ten.txt 2>/dev/null || echo "")
          echo "上次 ETag: [$LAST_ETAG_TEN]"
          echo "上次 Last-Modified: [$LAST_MOD_TEN]"
          
          CHANGED_TEN=false
          if [ -n "$ETAG_TEN" ] && ([ "$ETAG_TEN" != "$LAST_ETAG_TEN" ] || [ "$LASTMOD_TEN" != "$LAST_MOD_TEN" ]); then
            echo "十周年配置已更新！"
            echo "$ETAG_TEN" > .etag-cache/etag_ten.txt
            echo "$LASTMOD_TEN" > .etag-cache/mod_ten.txt
            CHANGED_TEN=true
          else
            echo "十周年配置无变化"
          fi
          
          # 检查OL
          echo "=== 检查OL配置 ==="
          HEADERS_OL=$(curl -sI "$URL_OL" 2>&1)
          ETAG_OL=$(echo "$HEADERS_OL" | grep -i "^etag:" | cut -d' ' -f2- | tr -d '\r\n "')
          LASTMOD_OL=$(echo "$HEADERS_OL" | grep -i "^last-modified:" | cut -d' ' -f2- | tr -d '\r\n')
          echo "当前 ETag: [$ETAG_OL]"
          echo "当前 Last-Modified: [$LASTMOD_OL]"
          
          LAST_ETAG_OL=$(cat .etag-cache/etag_ol.txt 2>/dev/null || echo "")
          LAST_MOD_OL=$(cat .etag-cache/mod_ol.txt 2>/dev/null || echo "")
          echo "上次 ETag: [$LAST_ETAG_OL]"
          echo "上次 Last-Modified: [$LAST_MOD_OL]"
          
          CHANGED_OL=false
          if [ -n "$ETAG_OL" ] && ([ "$ETAG_OL" != "$LAST_ETAG_OL" ] || [ "$LASTMOD_OL" != "$LAST_MOD_OL" ]); then
            echo "OL配置已更新！"
            echo "$ETAG_OL" > .etag-cache/etag_ol.txt
            echo "$LASTMOD_OL" > .etag-cache/mod_ol.txt
            CHANGED_OL=true
          else
            echo "OL配置无变化"
          fi
          
          # 设置输出变量
          if [ "$CHANGED_TEN" = true ] || [ "$CHANGED_OL" = true ]; then
            echo "has_change=true" >> $GITHUB_OUTPUT
            CHANGED_FILES=""
            [ "$CHANGED_TEN" = true ] && CHANGED_FILES="${CHANGED_FILES}十周年,"
            [ "$CHANGED_OL" = true ] && CHANGED_FILES="${CHANGED_FILES}ol,"
            CHANGED_FILES=${CHANGED_FILES%,}
            echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          else
            echo "has_change=false" >> $GITHUB_OUTPUT
          fi

      - name: 提交ETag缓存
        if: steps.check.outputs.has_change == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          echo "=== 当前目录内容 ==="
          ls -la .etag-cache/
          
          echo "=== 添加文件 ==="
          git add -f .etag-cache/
          
          echo "=== Git状态 ==="
          git status
          
          echo "=== 提交 ==="
          if git diff --staged --quiet; then
            echo "没有变化需要提交"
          else
            git commit -m "更新ETag缓存 $(date +'%Y-%m-%d %H:%M:%S')"
            
            echo "=== 配置远程仓库 ==="
            git remote set-url origin https://x-access-token:${{ secrets.READONLY_TOKEN }}@github.com/${{ github.repository }}.git
            
            echo "=== 推送 ==="
            git push
            echo "ETag缓存已提交"
          fi

      - name: 触发私有仓库解密
        run: |
          echo "触发私有仓库解密（无论是否检测到变化）"
          
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.READONLY_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ secrets.PRIVATE_REPO_OWNER }}/${{ secrets.PRIVATE_REPO_NAME }}/dispatches \
            -d "{\"event_type\":\"sgs-config-updated\",\"client_payload\":{\"timestamp\":\"$(date -Iseconds)\",\"changed\":[\"十周年\",\"ol\"],\"force\":true}}"
          
          echo "触发成功！"

      - name: 无变化说明
        if: steps.check.outputs.has_change != 'true'
        run: |
          echo "ETag/Last-Modified 无变化，但仍然触发解密以对比文件内容"

# 最后更新: 2026-02-27
          echo "当前 Last-Modified: $LASTMOD_TEN"
          
          LAST_ETAG_TEN=$(cat .etag-cache/etag_ten.txt 2>/dev/null || echo "")
          LAST_MOD_TEN=$(cat .etag-cache/mod_ten.txt 2>/dev/null || echo "")
          
          CHANGED_TEN=false
          if [ "$ETAG_TEN" != "$LAST_ETAG_TEN" ] || [ "$LASTMOD_TEN" != "$LAST_MOD_TEN" ]; then
            echo "十周年配置已更新！"
            echo "$ETAG_TEN" > .etag-cache/etag_ten.txt
            echo "$LASTMOD_TEN" > .etag-cache/mod_ten.txt
            CHANGED_TEN=true
          else
            echo "十周年配置无变化"
          fi
          
          # 检查OL
          echo "=== 检查OL配置 ==="
          ETAG_OL=$(curl -sI "$URL_OL" | grep -i "etag:" | cut -d' ' -f2 | tr -d '\r\n"')
          LASTMOD_OL=$(curl -sI "$URL_OL" | grep -i "last-modified:" | cut -d' ' -f2- | tr -d '\r\n')
          echo "当前 ETag: $ETAG_OL"
          echo "当前 Last-Modified: $LASTMOD_OL"
          
          LAST_ETAG_OL=$(cat .etag-cache/etag_ol.txt 2>/dev/null || echo "")
          LAST_MOD_OL=$(cat .etag-cache/mod_ol.txt 2>/dev/null || echo "")
          
          CHANGED_OL=false
          if [ "$ETAG_OL" != "$LAST_ETAG_OL" ] || [ "$LASTMOD_OL" != "$LAST_MOD_OL" ]; then
            echo "OL配置已更新！"
            echo "$ETAG_OL" > .etag-cache/etag_ol.txt
            echo "$LASTMOD_OL" > .etag-cache/mod_ol.txt
            CHANGED_OL=true
          else
            echo "OL配置无变化"
          fi
          
          # 设置输出变量
          if [ "$CHANGED_TEN" = true ] || [ "$CHANGED_OL" = true ]; then
            echo "has_change=true" >> $GITHUB_OUTPUT
            CHANGED_FILES=""
            [ "$CHANGED_TEN" = true ] && CHANGED_FILES="${CHANGED_FILES}十周年,"
            [ "$CHANGED_OL" = true ] && CHANGED_FILES="${CHANGED_FILES}ol,"
            CHANGED_FILES=${CHANGED_FILES%,}
            echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          else
            echo "has_change=false" >> $GITHUB_OUTPUT
          fi

      - name: 提交ETag缓存
        if: steps.check.outputs.has_change == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          echo "=== 当前目录内容 ==="
          ls -la .etag-cache/
          
          echo "=== 添加文件 ==="
          git add -f .etag-cache/
          
          echo "=== Git状态 ==="
          git status
          
          echo "=== 提交 ==="
          if git diff --staged --quiet; then
            echo "没有变化需要提交"
          else
            git commit -m "更新ETag缓存 $(date +'%Y-%m-%d %H:%M:%S')"
            
            echo "=== 配置远程仓库 ==="
            git remote set-url origin https://x-access-token:${{ secrets.READONLY_TOKEN }}@github.com/${{ github.repository }}.git
            
            echo "=== 推送 ==="
            git push
            echo "ETag缓存已提交"
          fi

      - name: 触发私有仓库解密
        if: steps.check.outputs.has_change == 'true'
        run: |
          echo "检测到配置文件更新，触发私有仓库解密"
          echo "变化的文件: ${{ steps.check.outputs.changed_files }}"
          
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.READONLY_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ secrets.PRIVATE_REPO_OWNER }}/${{ secrets.PRIVATE_REPO_NAME }}/dispatches \
            -d "{\"event_type\":\"sgs-config-updated\",\"client_payload\":{\"timestamp\":\"$(date -Iseconds)\",\"changed\":[\"${{ steps.check.outputs.changed_files }}\"]}}"
          
          echo "触发成功！"

      - name: 无变化
        if: steps.check.outputs.has_change != 'true'
        run: |
          echo "配置文件无变化，跳过触发"
          LAST_ETAG_TEN=$(cat .etag-cache/etag_ten.txt 2>/dev/null || echo "")
          LAST_MOD_TEN=$(cat .etag-cache/mod_ten.txt 2>/dev/null || echo "")
          
          CHANGED_TEN=false
          if [ "$ETAG_TEN" != "$LAST_ETAG_TEN" ] || [ "$LASTMOD_TEN" != "$LAST_MOD_TEN" ]; then
            echo "十周年配置已更新！"
            echo "$ETAG_TEN" > .etag-cache/etag_ten.txt
            echo "$LASTMOD_TEN" > .etag-cache/mod_ten.txt
            CHANGED_TEN=true
          else
            echo "十周年配置无变化"
          fi
          
          # 检查OL
          echo "=== 检查OL配置 ==="
          ETAG_OL=$(curl -sI "$URL_OL" | grep -i "etag:" | cut -d' ' -f2 | tr -d '\r\n"')
          LASTMOD_OL=$(curl -sI "$URL_OL" | grep -i "last-modified:" | cut -d' ' -f2- | tr -d '\r\n')
          echo "当前 ETag: $ETAG_OL"
          echo "当前 Last-Modified: $LASTMOD_OL"
          
          LAST_ETAG_OL=$(cat .etag-cache/etag_ol.txt 2>/dev/null || echo "")
          LAST_MOD_OL=$(cat .etag-cache/mod_ol.txt 2>/dev/null || echo "")
          
          CHANGED_OL=false
          if [ "$ETAG_OL" != "$LAST_ETAG_OL" ] || [ "$LASTMOD_OL" != "$LAST_MOD_OL" ]; then
            echo "OL配置已更新！"
            echo "$ETAG_OL" > .etag-cache/etag_ol.txt
            echo "$LASTMOD_OL" > .etag-cache/mod_ol.txt
            CHANGED_OL=true
          else
            echo "OL配置无变化"
          fi
          
          # 设置输出变量
          if [ "$CHANGED_TEN" = true ] || [ "$CHANGED_OL" = true ]; then
            echo "has_change=true" >> $GITHUB_OUTPUT
            CHANGED_FILES=""
            [ "$CHANGED_TEN" = true ] && CHANGED_FILES="${CHANGED_FILES}十周年,"
            [ "$CHANGED_OL" = true ] && CHANGED_FILES="${CHANGED_FILES}ol,"
            CHANGED_FILES=${CHANGED_FILES%,}
            echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          else
            echo "has_change=false" >> $GITHUB_OUTPUT
          fi

      - name: 提交ETag缓存
        if: steps.check.outputs.has_change == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          echo "=== 当前目录内容 ==="
          ls -la .etag-cache/
          
          echo "=== 添加文件 ==="
          git add -f .etag-cache/
          
          echo "=== Git状态 ==="
          git status
          
          echo "=== 提交 ==="
          if git diff --staged --quiet; then
            echo "没有变化需要提交"
          else
            git commit -m "更新ETag缓存 $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "ETag缓存已提交"
          fi

      - name: 触发私有仓库解密
        if: steps.check.outputs.has_change == 'true'
        run: |
          echo "检测到配置文件更新，触发私有仓库解密"
          echo "变化的文件: ${{ steps.check.outputs.changed_files }}"
          
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.READONLY_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ secrets.PRIVATE_REPO_OWNER }}/${{ secrets.PRIVATE_REPO_NAME }}/dispatches \
            -d "{\"event_type\":\"sgs-config-updated\",\"client_payload\":{\"timestamp\":\"$(date -Iseconds)\",\"changed\":[\"${{ steps.check.outputs.changed_files }}\"]}}"
          
          echo "触发成功！"

      - name: 无变化
        if: steps.check.outputs.has_change != 'true'
        run: |
          echo "配置文件无变化，跳过触发"
          LAST_ETAG_TEN=$(cat .etag-cache/etag_ten.txt 2>/dev/null || echo "")
          LAST_MOD_TEN=$(cat .etag-cache/mod_ten.txt 2>/dev/null || echo "")
          
          CHANGED_TEN=false
          if [ "$ETAG_TEN" != "$LAST_ETAG_TEN" ] || [ "$LASTMOD_TEN" != "$LAST_MOD_TEN" ]; then
            echo "十周年配置已更新！"
            echo "$ETAG_TEN" > .etag-cache/etag_ten.txt
            echo "$LASTMOD_TEN" > .etag-cache/mod_ten.txt
            CHANGED_TEN=true
          else
            echo "十周年配置无变化"
          fi
          
          # 检查OL
          echo "=== 检查OL配置 ==="
          ETAG_OL=$(curl -sI "$URL_OL" | grep -i "etag:" | cut -d' ' -f2 | tr -d '\r\n"')
          LASTMOD_OL=$(curl -sI "$URL_OL" | grep -i "last-modified:" | cut -d' ' -f2- | tr -d '\r\n')
          echo "当前 ETag: $ETAG_OL"
          echo "当前 Last-Modified: $LASTMOD_OL"
          
          LAST_ETAG_OL=$(cat .etag-cache/etag_ol.txt 2>/dev/null || echo "")
          LAST_MOD_OL=$(cat .etag-cache/mod_ol.txt 2>/dev/null || echo "")
          
          CHANGED_OL=false
          if [ "$ETAG_OL" != "$LAST_ETAG_OL" ] || [ "$LASTMOD_OL" != "$LAST_MOD_OL" ]; then
            echo "OL配置已更新！"
            echo "$ETAG_OL" > .etag-cache/etag_ol.txt
            echo "$LASTMOD_OL" > .etag-cache/mod_ol.txt
            CHANGED_OL=true
          else
            echo "OL配置无变化"
          fi
          
          # 设置输出变量
          if [ "$CHANGED_TEN" = true ] || [ "$CHANGED_OL" = true ]; then
            echo "has_change=true" >> $GITHUB_OUTPUT
            CHANGED_FILES=""
            [ "$CHANGED_TEN" = true ] && CHANGED_FILES="${CHANGED_FILES}十周年,"
            [ "$CHANGED_OL" = true ] && CHANGED_FILES="${CHANGED_FILES}ol,"
            CHANGED_FILES=${CHANGED_FILES%,}
            echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          else
            echo "has_change=false" >> $GITHUB_OUTPUT
          fi

      - name: 提交ETag缓存
        if: steps.check.outputs.has_change == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .etag-cache/
          git commit -m "更新ETag缓存 $(date +'%Y-%m-%d %H:%M:%S')" || echo "无需提交"
          git push || echo "推送失败"

      - name: 触发私有仓库解密
        if: steps.check.outputs.has_change == 'true'
        run: |
          echo "检测到配置文件更新，触发私有仓库解密"
          echo "变化的文件: ${{ steps.check.outputs.changed_files }}"
          
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.READONLY_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ secrets.PRIVATE_REPO_OWNER }}/${{ secrets.PRIVATE_REPO_NAME }}/dispatches \
            -d "{\"event_type\":\"sgs-config-updated\",\"client_payload\":{\"timestamp\":\"$(date -Iseconds)\",\"changed\":[\"${{ steps.check.outputs.changed_files }}\"]}}"
          
          echo "触发成功！"

      - name: 无变化
        if: steps.check.outputs.has_change != 'true'
        run: |
          echo "配置文件无变化，跳过触发"
