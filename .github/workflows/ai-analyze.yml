name: AI 代码分析助手

on:
  workflow_dispatch:
    inputs:
      question:
        description: '你想问什么问题？'
        required: true
        type: string

jobs:
  ai-analyze:
    runs-on: ubuntu-latest
    env:
      READONLY_TOKEN: ${{ secrets.READONLY_TOKEN }}
      AI_API_URL: ${{ secrets.AI_API_URL }}
      AI_API_KEY: ${{ secrets.AI_API_KEY }}
      
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.READONLY_TOKEN }}
          fetch-depth: 1

      - name: 读取仓库结构
        id: read-code
        run: |
          echo "仓库根目录:" > result.txt
          ls -la >> result.txt
          
          if [ -d "三国杀十周年" ]; then
            echo "" >> result.txt
            echo "=== 三国杀十周年 目录 ===" >> result.txt
            ls "三国杀十周年" | head -20 >> result.txt
          fi
          
          if [ -d "ol" ]; then
            echo "" >> result.txt
            echo "=== ol 目录 ===" >> result.txt
            ls "ol" | head -20 >> result.txt
          fi
          
          cat result.txt
          echo "content<<EOF" >> $GITHUB_OUTPUT
          cat result.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 调用 AI 分析
        id: ai-call
        run: |
          QUESTION="${{ github.event.inputs.question }}"
          CONTENT="${{ steps.read-code.outputs.content }}"
          
          RESPONSE=$(curl -s -X POST "${AI_API_URL}/chat/completions" \
            -H "Authorization: Bearer ${AI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"model\":\"grok-4\",\"messages\":[{\"role\":\"system\",\"content\":\"你是一个专业的代码分析助手。请用中文简洁回答用户的问题。\"},{\"role\":\"user\",\"content\":\"问题: ${QUESTION}\\n\\n仓库结构:\\n${CONTENT}\"}]}")
          
          echo "$RESPONSE" > ai_response.json
          cat ai_response.json

      - name: 输出结果
        run: |
          echo "## AI 分析结果"
          cat ai_response.json
